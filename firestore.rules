/**
 * @fileoverview Firestore Security Rules for Vibee OS Lite.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-related data
 * (profiles, vibes, mood history). Global tags are publicly readable. A global
 * feed of vibes is also publicly readable by authenticated users.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @return {boolean} True if the request is authenticated, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the request is made by the owner of the resource.
     * @param {string} userId The user ID to compare against the request's auth UID.
     * @return {boolean} True if the request is made by the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Rules for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (get, update) - Owner can read and update their own profile.
     * @allow (create) - Authenticated user can create their own profile.
     * @deny (list, delete) - Listing users is disabled for privacy. Deletion is restricted.
     */
    match /users/{userId} {
      allow get, update: if isOwner(userId);
      allow list: if false; 
      allow create: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for the private /users/{userId}/vibes/{vibeId} collection.
     * @path /users/{userId}/vibes/{vibeId}
     * @allow (read, write) - Authenticated user can manage their own vibes.
     */
    match /users/{userId}/vibes/{vibeId} {
      allow read, write: if isOwner(userId);
    }

    /**
     * @description Rules for the public /all-vibes collection.
     * @path /all-vibes/{vibeId}
     * @allow (read, create, update) - Any signed-in user can read/create/update vibes.
     * @allow (delete) - Owner of the vibe can delete it.
     */
    match /all-vibes/{vibeId} {
      allow read, create: if isSignedIn();
      allow update: if isSignedIn(); // Allows for incrementing view counts, etc.
      allow delete: if isOwner(resource.data.userId);

      /**
       * @description Rules for comments on a vibe.
       * @path /all-vibes/{vibeId}/comments/{commentId}
       */
      match /comments/{commentId} {
        allow read, create: if isSignedIn();
        allow update, delete: if false; // Comments are immutable.
      }

      /**
       * @description Rules for reactions on a vibe.
       * @path /all-vibes/{vibeId}/reactions/{reactionId}
       */
      match /reactions/{reactionId} {
        allow read, create: if isSignedIn();
        // Allow user to delete their own reaction
        allow delete: if isOwner(resource.data.userId);
        allow update: if false; // Reactions are immutable.
      }
    }

    /**
     * @description Rules for the /tags/{tagId} collection.
     * @path /tags/{tagId}
     */
    match /tags/{tagId} {
      allow get, list: if true;
      allow create, update, delete: if false; // Admin-only
    }
    
    /**
     * @description Rules for the /vibeMemory/{userId} collection.
     * @path /vibeMemory/{userId}
     * @allow (read, write) - Only the owner can manage their vibe memory.
     */
    match /vibeMemory/{userId} {
        allow read, write: if isOwner(userId);
    }

    /**
     * @description Rules for the /users/{userId}/moodHistory/{moodHistoryId} collection.
     * @path /users/{userId}/moodHistory/{moodHistoryId}
     */
    match /users/{userId}/moodHistory/{moodHistoryId} {
      allow read, write: if isOwner(userId);
    }
  }
}
