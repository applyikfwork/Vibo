/**
 * @fileoverview Firestore Security Rules for Vibee OS Lite.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-related data
 * (profiles, vibes, mood history). Global tags are publicly readable. A global
 * feed of vibes is also publicly readable by authenticated users.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @return {boolean} True if the request is authenticated, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the request is made by the owner of the resource.
     * @param {string} userId The user ID to compare against the request's auth UID.
     * @return {boolean} True if the request is made by the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * @description Validates the structure and content of an incoming Vibe document.
     */
    function isValidVibe() {
      let data = request.resource.data;
      return data.userId == request.auth.uid &&
             data.text is string && data.text.size() <= 280 &&
             data.emoji is string && data.emoji.size() <= 4 &&
             data.emotion is string &&
             data.backgroundColor is string &&
             data.timestamp == request.time &&
             data.isAnonymous is bool &&
             (!('isVoiceNote' in data) || data.isVoiceNote is bool) &&
             (!('audioUrl' in data) || (data.audioUrl is string && data.audioUrl.size() < 1024)) &&
             (!('audioDuration' in data) || data.audioDuration is number);
    }
    
    /**
     * @description Rules for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (get, update) - Owner can read and update their own profile.
     * @allow (create) - Authenticated user can create their own profile.
     * @deny (list, delete) - Listing users is disabled for privacy. Deletion is restricted.
     */
    match /users/{userId} {
      allow get, update, create, delete: if isOwner(userId);
      allow list: if false; 
    }

    /**
     * @description Rules for the private /users/{userId}/vibes/{vibeId} collection.
     * @path /users/{userId}/vibes/{vibeId}
     * @allow (read, write) - Authenticated user can manage their own vibes.
     */
    match /users/{userId}/vibes/{vibeId} {
      allow read, write: if isOwner(userId);
    }

    /**
     * @description Rules for the public /all-vibes collection.
     * @path /all-vibes/{vibeId}
     * @allow (read, create, update) - Any signed-in user can read/create/update vibes.
     * @allow (delete) - Owner of the vibe can delete it.
     */
    match /all-vibes/{vibeId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isValidVibe();
      allow update: if isSignedIn(); // Allows for incrementing view counts, reactions, etc.
      allow delete: if isOwner(resource.data.userId);

      /**
       * @description Rules for comments on a vibe.
       * @path /all-vibes/{vibeId}/comments/{commentId}
       */
      match /comments/{commentId} {
        allow read, create: if isSignedIn();
        allow update, delete: if isOwner(request.resource.data.userId); 
      }

      /**
       * @description Rules for reactions on a vibe.
       * @path /all-vibes/{vibeId}/reactions/{reactionId}
       */
      match /reactions/{reactionId} {
        allow read, create: if isSignedIn();
        // Allow user to delete their own reaction
        allow delete: if isOwner(resource.data.userId);
        allow update: if false; // Reactions are immutable.
      }
    }

    /**
     * @description Rules for the /tags/{tagId} collection.
     * @path /tags/{tagId}
     */
    match /tags/{tagId} {
      allow get, list: if true;
      allow create, update, delete: if false; // Admin-only
    }
    
    /**
     * @description Rules for the /vibeMemory/{userId} collection.
     * @path /vibeMemory/{userId}
     * @allow (read, write) - Only the owner can manage their vibe memory.
     */
    match /vibeMemory/{userId} {
        allow read, write: if isOwner(userId);
    }

    /**
     * @description Rules for the /users/{userId}/moodHistory/{moodHistoryId} collection.
     * @path /users/{userId}/moodHistory/{moodHistoryId}
     */
    match /users/{userId}/moodHistory/{moodHistoryId} {
      allow read, write: if isOwner(userId);
    }
    
    // --- Student Mental Health Hub Rules ---

    /**
     * @description Student profiles with sensitive settings.
     * @path /student-profiles/{userId}
     */
    match /student-profiles/{userId} {
      allow read, write: if isOwner(userId);
    }

    /**
     * @description Records of student study breaks.
     * @path /study-breaks/{breakId}
     */
    match /study-breaks/{breakId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read: if isOwner(resource.data.userId);
    }

    /**
     * @description Peer support groups for students.
     * @path /peer-support-circles/{circleId}
     */
    match /peer-support-circles/{circleId} {
      // Any signed-in user can read circle data (e.g., to see if it's full)
      allow read: if isSignedIn();
      // Any signed-in user can create a new circle
      allow create: if isSignedIn();
      // Allow a user to add themselves to a circle, but not others.
      allow update: if isSignedIn() && 
                       request.resource.data.students.hasAll(resource.data.students) &&
                       request.resource.data.students.size() == resource.data.students.size() + 1 &&
                       request.auth.uid in request.resource.data.students;
    }
    
    /**
     * @description Secure link between student and parent email for dashboard access.
     * @path /parent-access/{accessId}
     */
    match /parent-access/{accessId} {
      // A student can create a link for their parent.
      allow create: if isOwner(request.resource.data.studentUserId);
      // Only a parent whose email matches can read the link to find their student's ID.
      allow list: if isSignedIn() && request.query.where.get(0)[2] == request.auth.token.email;
      allow read, update, delete: if false; // Links are immutable and unreadable directly for privacy.
    }
  }
}
